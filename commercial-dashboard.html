<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Financeiro - Comercial</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121a33;
      --text: #e8ecff;
      --muted: #9aa7d8;
      --ok: #35d07f;
      --warn: #ffcc66;
      --bad: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1020, #0d1328);
      color: var(--text);
      font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
      padding: 16px;
    }
    .topbar { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    button {
      background:#1a2a57;
      color:#e8ecff;
      border:1px solid #3552a3;
      border-radius:9px;
      padding:8px 12px;
      cursor:pointer;
    }
    h1,h2,h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    .two{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .card{background:var(--card);border:1px solid #1f2f63;border-radius:14px;padding:14px}
    .kpi{font-size:2rem;font-weight:800}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.82rem}
    .ok{background:rgba(53,208,127,.16);color:#8ef0b7}
    .warn{background:rgba(255,204,102,.2);color:#ffd97c}
    .bad{background:rgba(255,107,107,.2);color:#ffb1b1}
    table{width:100%;border-collapse:collapse;font-size:.94rem}
    th,td{padding:8px;border-bottom:1px solid #243566;text-align:left}
    th{color:var(--muted)}
    .decision{padding:4px 10px;border-radius:999px;font-weight:700;font-size:.8rem;display:inline-block}
    .d-buy{background:rgba(53,208,127,.2);color:#8ef0b7}
    .d-hold{background:rgba(255,204,102,.2);color:#ffd97c}
    .d-avoid{background:rgba(255,107,107,.2);color:#ffb1b1}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>Bitdash - Buy it Dashboard</h1>
      <div class="muted">Visualize, entenda, decida!</div>
    </div>
    <div class="actions">
      <button onclick="location.href='commercial-add-assets.html'">+ Adicionar ativos</button>
      <button onclick="location.href='commercial-auth.html'" id="authBtn">Cadastro/Login Premium</button>
      <button id="saveBtn" class="hidden">Salvar carteira (Premium)</button>
      <button id="logoutBtn" class="hidden">Sair</button>
    </div>
  </div>

  <div class="grid cards">
    <div class="card">
      <div class="muted">Patrim√¥nio da carteira (estimado)</div>
      <div class="kpi" id="kTotal">R$ 0,00</div>
    </div>
    <div class="card">
      <div class="muted">Valor em FIIs (estimado)</div>
      <div class="kpi" id="kFiis">R$ 0,00</div>
      <div class="muted" id="kFiisPct">0% do total</div>
    </div>
    <div class="card">
      <div class="muted">Valor em a√ß√µes (estimado)</div>
      <div class="kpi" id="kAcoes">R$ 0,00</div>
      <div class="muted" id="kAcoesPct">0% do total</div>
    </div>
    <div class="card">
      <div class="muted">Ativos monitorados</div>
      <div class="kpi" id="kCount">0</div>
      <div class="muted">Ativos na carteira</div>
    </div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h3>Aloca√ß√£o por bloco (barras horizontais)</h3>
      <div id="chartWrap" style="width:100%; max-width:100%; height:260px; overflow-y:auto; overflow-x:hidden; border:1px solid #233565; border-radius:10px; padding:8px;"><canvas id="allocChart"></canvas></div>
      <div class="muted" style="margin-top:8px;text-align:center">Visual em barras para leitura mais clara</div>
    </div>
  </div>

  <div class="grid two" style="margin-top:14px;">
    <div class="card">
      <h3>Leitura r√°pida</h3>
      <div class="pill ok">Pontos fortes</div>
      <ul>
        <li>Decis√£o de compra visual por ativo com regra objetiva.</li>
        <li>Atualiza√ß√£o autom√°tica de m√∫ltiplos por fonte p√∫blica.</li>
        <li>Fluxo de cadastro em texto livre (r√°pido e escal√°vel).</li>
      </ul>
      <div class="pill warn">Aten√ß√µes</div>
      <ul>
        <li>M√©tricas dependem da disponibilidade das fontes externas.</li>
        <li>Sempre valide ativos de baixa liquidez antes de comprar.</li>
      </ul>
    </div>
    <div class="card" style="max-height:360px; overflow:auto;">
      <h3>Invent√°rio de posi√ß√µes</h3>
      <div class="muted">Separado por classe com valor unit√°rio e total por ativo (estimado).</div>

      <h4 style="margin:10px 0 6px;">FIIs</h4>
      <table>
        <thead><tr><th>Ativo</th><th>Qtd</th><th>Valor cota</th><th>Valor total</th></tr></thead>
        <tbody id="invFiis"></tbody>
      </table>

      <h4 style="margin:12px 0 6px;">A√ß√µes</h4>
      <table>
        <thead><tr><th>Ativo</th><th>Qtd</th><th>Valor cota</th><th>Valor total</th></tr></thead>
        <tbody id="invAcoes"></tbody>
      </table>

      <h4 style="margin:12px 0 6px;">Criptos</h4>
      <table>
        <thead><tr><th>Ativo</th><th>Qtd</th><th>Valor unidade</th><th>Valor total</th></tr></thead>
        <tbody id="invCriptos"></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3>Painel de decis√£o instant√¢nea (FII/A√ß√µes/Cripto)</h3>
    <div class="muted">Bot√£o autom√°tico busca m√∫ltiplos no Investidor10 e responde se deve comprar ou n√£o, com regra espec√≠fica por classe.</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0;">
      <button id="refreshBtn">Atualizar P/VP autom√°tico</button>
      <span id="status" class="muted">Aguardando atualiza√ß√£o.</span>
      <span id="mode" class="muted"></span>
    </div>
    <table>
      <thead><tr><th>Ativo</th><th>Classe</th><th>M√©trica atual</th><th>Decis√£o</th><th>Motivo</th></tr></thead>
      <tbody id="decisionRows"></tbody>
    </table>
  </div>

<script>
const API = `http://${location.hostname}:3001`;
const DEFAULT_PORT=[
  {ticker:'MXRF11', qty:120, cls:'FII'},
  {ticker:'HGLG11', qty:60, cls:'FII'},
  {ticker:'PETR4', qty:30, cls:'A√á√ÉO'},
  {ticker:'WEGE3', qty:12, cls:'A√á√ÉO'},
];


const CRYPTO_SET = new Set(['BTC','BITCOIN','ETH','SOL','XRP','BNB','ADA','DOGE','LTC','USDT']);
const CRYPTO_MAP = { BTC:'bitcoin', ETH:'ethereum', SOL:'solana', XRP:'ripple', BNB:'binancecoin', ADA:'cardano', DOGE:'dogecoin', LTC:'litecoin', USDT:'tether' };

const rules = {
  FII:{g:0.90,y:1.00},
  ACAO:{g:1.10,y:1.80}, // usando P/VP para a√ß√µes na demo
  WEGE3:{g:2.0,y:3.0},
  PETR4:{g:1.0,y:1.6}
};

let portfolio = DEFAULT_PORT.slice();
let metrics = {};
let marketPrices = {};
let usdBrl = 5.2;
let currentUser = null;

async function api(path, method='GET', body){
  const r = await fetch(API+path, {
    method,
    headers: {'Content-Type':'application/json'},
    credentials: 'include',
    body: body ? JSON.stringify(body) : undefined,
  });
  let j={}; try{ j=await r.json(); }catch{}
  if(!r.ok || j.ok===false) throw new Error(j.error || `http_${r.status}`);
  return j;
}

function isPremium(){ return !!currentUser?.email; }

async function loadPortfolio(){
  try {
    const me = await api('/auth/me');
    currentUser = me.user;
    const saved = await api('/portfolio');
    if (saved?.portfolio?.length) return saved.portfolio;
  } catch {
    currentUser = null;
  }

  const inbound = JSON.parse(sessionStorage.getItem('inboundPortfolio')||'null');
  if (inbound?.length) {
    sessionStorage.setItem('freePortfolio', JSON.stringify(inbound));
    sessionStorage.removeItem('inboundPortfolio');
    return inbound;
  }
  const free = JSON.parse(sessionStorage.getItem('freePortfolio')||'null');
  if (free?.length) return free;
  return DEFAULT_PORT.slice();
}

function normalizeTicker(t){ return t==='BITCOIN' ? 'BTC' : t; }
function classify(t){ t=normalizeTicker(t); if (CRYPTO_SET.has(t)) return 'CRIPTO'; if (['IVV','SCHD'].includes(t)) return 'ETF EUA'; return t.endsWith('11') ? 'FII' : 'A√á√ÉO'; }

function signal(asset, v){
  if (v == null) return ['AGUARDANDO', 'd-hold'];
  if (asset.cls === 'CRIPTO') {
    // v = varia√ß√£o 24h (%). Queda forte = oportunidade, alta forte = evitar topo.
    if (v <= -4) return ['üü¢ COMPRAR FORTE','d-buy'];
    if (v <= 2) return ['üü° COMPRAR NORMAL','d-hold'];
    return ['üî¥ EVITAR AGORA','d-avoid'];
  }
  const custom = rules[asset.ticker];
  const base = custom || (asset.cls==='FII' ? rules.FII : rules.ACAO);
  if (v <= base.g) return ['üü¢ COMPRAR FORTE','d-buy'];
  if (v <= base.y) return ['üü° COMPRAR NORMAL','d-hold'];
  return ['üî¥ EVITAR AGORA','d-avoid'];
}

function reason(asset){
  if (asset.cls==='FII') return 'Faixa P/VP de desconto melhora retorno do reinvestimento.';
  if (asset.cls==='CRIPTO') return 'Regra por varia√ß√£o 24h: queda forte favorece aporte; alta forte pede cautela.';
  if (asset.cls==='ETF EUA') return 'ETF global: usar m√∫ltiplo com disciplina evita comprar esticado.';
  return 'P/VP baixo aumenta margem de seguran√ßa para entrada.';
}

function withTimeout(promise, ms=12000){
  return Promise.race([promise, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))]);
}

function parseBrNum(str){
  return Number(String(str||'').replace(/\./g,'').replace(',', '.'));
}

async function fetchUsdBrl(){
  try {
    const r = await withTimeout(fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL?_=' + Date.now(), { cache:'no-store' }), 8000);
    const j = await r.json();
    const v = Number(j?.USDBRL?.bid);
    if (Number.isFinite(v) && v > 0) usdBrl = v;
  } catch {}
}

async function fetchLivePrice(asset){
  const t = asset.ticker.toLowerCase();

  if (asset.cls === 'CRIPTO') {
    const id = CRYPTO_MAP[asset.ticker];
    if (!id) throw new Error('crypto map nf');
    const u = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&_=${Date.now()}`;
    const r = await withTimeout(fetch(u, { cache:'no-store' }), 10000);
    const j = await r.json();
    const usd = Number(j?.[id]?.usd);
    if (!Number.isFinite(usd)) throw new Error('crypto px nf');
    return usd * usdBrl;
  }

  const url = asset.cls==='FII'
    ? `https://r.jina.ai/http://investidor10.com.br/fiis/${t}/`
    : (asset.cls==='ETF EUA'
      ? `https://r.jina.ai/http://investidor10.com.br/etfs-global/${t}/`
      : `https://r.jina.ai/http://investidor10.com.br/acoes/${t}/`);

  const res = await withTimeout(fetch(url + (url.includes('?')?'&':'?') + '_=' + Date.now(), { cache:'no-store' }), 12000);
  if (!res.ok) throw new Error('price fetch fail');
  const txt = await res.text();

  let m = txt.match(/Valor atual\s*R\$\s*([0-9\.]+,[0-9]+)/i)
    || txt.match(/Cota√ß√£o\s*R\$\s*([0-9\.]+,[0-9]+)/i)
    || txt.match(/Pre√ßo\s*R\$\s*([0-9\.]+,[0-9]+)/i);
  if (m) return parseBrNum(m[1]);

  // fallback: ETF global pode vir em d√≥lar
  m = txt.match(/Valor atual\s*US\$\s*([0-9\.]+,[0-9]+)/i)
    || txt.match(/Cota√ß√£o\s*US\$\s*([0-9\.]+,[0-9]+)/i)
    || txt.match(/US\$\s*([0-9\.]+,[0-9]+)/i);
  if (m) return parseBrNum(m[1]) * usdBrl;

  throw new Error('price not found');
}

async function fetchPvp(asset){
  const t = asset.ticker.toLowerCase();
  if (asset.cls === 'CRIPTO') {
    const id = CRYPTO_MAP[asset.ticker];
    if (!id) throw new Error('crypto map nf');
    const u = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true&_=${Date.now()}`;
    const r = await fetch(u);
    if (!r.ok) throw new Error('crypto fetch fail');
    const j = await r.json();
    const ch = j?.[id]?.usd_24h_change;
    if (typeof ch !== 'number') throw new Error('crypto metric nf');
    return ch; // varia√ß√£o 24h
  }
  const url = asset.cls==='FII'
    ? `https://r.jina.ai/http://investidor10.com.br/fiis/${t}/`
    : (asset.cls==='ETF EUA'
      ? `https://r.jina.ai/http://investidor10.com.br/etfs-global/${t}/`
      : `https://r.jina.ai/http://investidor10.com.br/acoes/${t}/`);
  const res = await withTimeout(fetch(url + (url.includes("?")?"&":"?") + "_=" + Date.now(), { cache: "no-store" }), 12000);
  if (!res.ok) throw new Error('fetch fail');
  const txt = await res.text();
  let m = txt.match(/P\/VP\s*([0-9]+,[0-9]+)/i) || txt.match(/P\/VP[^0-9]*([0-9]+,[0-9]+)/i);
  if (!m) throw new Error('pvp nf');
  return Number(m[1].replace(',','.'));
}

function render(){
  document.getElementById('authBtn').textContent = currentUser?.email ? `Premium: ${currentUser.email}` : 'Cadastro/Login Premium';
  document.getElementById('saveBtn').classList.toggle('hidden', !isPremium());
  document.getElementById('logoutBtn').classList.toggle('hidden', !isPremium());
  document.getElementById('mode').textContent = isPremium()
    ? 'Modo premium: pode salvar e recuperar depois.'
    : 'Modo gr√°tis: ao sair do site, os dados podem ser perdidos (amostra).';

  const invFiis = document.getElementById('invFiis'); invFiis.innerHTML='';
  const invAcoes = document.getElementById('invAcoes'); invAcoes.innerHTML='';
  const invCriptos = document.getElementById('invCriptos'); invCriptos.innerHTML='';
  const dec = document.getElementById('decisionRows'); dec.innerHTML='';

  portfolio.forEach(a=>{
    const unit = unitPrice(a);
    const total = estimateValue(a);
    const trInv=document.createElement('tr');
    trInv.innerHTML=`<td><strong>${a.ticker}</strong></td><td>${Number(a.qty).toLocaleString('pt-BR',{maximumFractionDigits:8})}</td><td>${brl(unit)}</td><td>${brl(total)}</td>`;
    if (a.cls==='FII') invFiis.appendChild(trInv);
    else if (a.cls==='CRIPTO') invCriptos.appendChild(trInv);
    else invAcoes.appendChild(trInv);

    const v = metrics[a.ticker];
    const [txt, cls] = signal(a,v);
    const tr2=document.createElement('tr');
    tr2.innerHTML=`<td><strong>${a.ticker}</strong></td><td>${a.cls}</td><td>${v!=null?(a.cls==='CRIPTO'?`${v.toFixed(2)}% (24h)`:v.toFixed(2)):'-'}</td><td><span class="decision ${cls}">${txt}</span></td><td>${reason(a)}</td>`;
    dec.appendChild(tr2);
  });
  updateSummary();
}

async function refresh(){
  let ok=0, fail=0, pxOk=0, pxFail=0;
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  document.getElementById('status').textContent='Atualizando m√©tricas e pre√ßos...';

  await fetchUsdBrl();

  await Promise.allSettled(portfolio.map(async (a)=>{
    try { metrics[a.ticker] = await fetchPvp(a); ok++; }
    catch { fail++; }
    try { marketPrices[a.ticker] = await fetchLivePrice(a); pxOk++; }
    catch { pxFail++; }
  }));

  document.getElementById('status').textContent=`P/VP/24h: ${ok} ok, ${fail} falhas ‚Ä¢ Pre√ßos: ${pxOk} ok, ${pxFail} falhas (USD/BRL ${usdBrl.toFixed(2)}).`;
  btn.disabled = false;
  render();
}

// chart
let allocChart;

function brl(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

const priceRef = {
  MXRF11: 10.3, HGLG11: 158.0, PETR4: 37.8, WEGE3: 53.0,
  VISC11: 108.0, KNRI11: 151.0, BBAS3: 31.0, VALE3: 55.0
};
const usdRef = {BTC:98000, ETH:3200, SOL:180, XRP:0.6, BNB:650, ADA:0.8, DOGE:0.12, LTC:90, USDT:1};

function unitPrice(asset){
  if (Number.isFinite(marketPrices[asset.ticker])) return marketPrices[asset.ticker];
  if (asset.cls==='CRIPTO') return (usdRef[asset.ticker] || 1) * usdBrl;
  return priceRef[asset.ticker] || 20;
}

function estimateValue(asset){
  return asset.qty * unitPrice(asset);
}

function updateSummary(){
  let total=0, fiis=0, acoes=0;
  const byTicker = [];
  portfolio.forEach(a=>{
    const val = estimateValue(a);
    total += val;
    if(a.cls==='FII') fiis += val; else acoes += val;
    byTicker.push({label:a.ticker, value:val});
  });

  document.getElementById('kTotal').textContent = brl(total);
  document.getElementById('kFiis').textContent = brl(fiis);
  document.getElementById('kAcoes').textContent = brl(acoes);
  document.getElementById('kCount').textContent = String(portfolio.length);
  document.getElementById('kFiisPct').textContent = total?`${(fiis*100/total).toFixed(1).replace('.',',')}% do total`:'0% do total';
  document.getElementById('kAcoesPct').textContent = total?`${(acoes*100/total).toFixed(1).replace('.',',')}% do total`:'0% do total';

  byTicker.sort((a,b)=>b.value-a.value);
  const labels = byTicker.map(x=>x.label);
  const data = byTicker.map(x=>x.value);
  const c = document.getElementById('allocChart');
  const wrap = document.getElementById('chartWrap');
  c.width = Math.max(320, wrap.clientWidth - 18);
  c.height = Math.max(260, labels.length * 34);

  if (!allocChart){
    allocChart = new Chart(document.getElementById('allocChart'), {
      type:'bar',
      data:{labels, datasets:[{label:'R$', data, backgroundColor:['#6ea8fe','#6dd3a0','#f6c15a','#c48cff','#8bd1ff','#f48fb1']} ]},
      options:{
        responsive:false,
        indexAxis:'y',
        maintainAspectRatio:false,
        scales:{
          x:{ticks:{color:'#dce5ff'}, grid:{color:'rgba(120,150,220,.28)'}},
          y:{ticks:{color:'#dce5ff'}, grid:{color:'rgba(120,150,220,.18)'}}
        },
        plugins:{legend:{labels:{color:'#e8ecff'}}}
      }
    });
  } else {
    allocChart.data.labels = labels;
    allocChart.data.datasets[0].data = data;
    allocChart.update();
  }
}

// actions
document.getElementById('refreshBtn').onclick = refresh;
document.getElementById('saveBtn').onclick = async ()=>{
  if (!isPremium()) return;
  try {
    await api('/portfolio','POST',{ portfolio });
    alert('Carteira salva com sucesso.');
  } catch (e) {
    alert('Erro ao salvar: ' + e.message);
  }
};
document.getElementById('logoutBtn').onclick = async ()=>{
  try { await api('/auth/logout','POST',{}); } catch {}
  location.reload();
};

window.addEventListener('resize', () => {
  updateSummary();
});

(async function init(){
  portfolio = (await loadPortfolio()).map(x=>({ ...x, ticker: normalizeTicker(x.ticker), cls: x.cls || classify(x.ticker) }));
  render();
  refresh();
})();
</script>
</body>
</html>