<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login Premium</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--text:#e8edff;--muted:#9aa7d8;--line:#2b3d72;--btn:#1b2d5e;--btnLine:#3d58a6}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:grid;place-items:center;background:linear-gradient(180deg,#0b1020,#0d1328);color:var(--text);font-family:Inter,Segoe UI,Arial;padding:20px}
    .card{width:100%;max-width:760px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px}
    h1{margin-top:0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .sep{margin:12px 0;color:#8ca0de;font-size:.9rem;display:flex;align-items:center;gap:10px}
    .sep::before,.sep::after{content:'';flex:1;height:1px;background:#2d3f74}
    #googleWrap{display:flex;justify-content:center;min-height:42px}
    button,a.btn{background:var(--btn);color:#fff;border:1px solid var(--btnLine);border-radius:9px;padding:9px 12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center}
  
    #diagPanel{margin-top:12px;padding:10px;border:1px dashed #3d58a6;border-radius:10px;background:#0a132e;color:#bcd0ff;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;display:none}
    #diagPanel.show{display:block}
    </style>
</head>
<body>
  <div class="card">
    <h1>Login Premium <span class="muted" style="font-size:.8rem">build 2026-02-17-auth3</span></h1>
    <div class="muted">Entre com Google. O sistema usa a conta já logada no seu navegador/dispositivo quando possível.</div>

    <div class="row">
      <button onclick="location.href='commercial-dashboard.html'">Voltar</button>
    </div>

    <div class="sep">Entrar com Google</div>
    <div id="googleWrap"></div>

    <div id="status" class="muted" style="margin-top:10px;"></div>
  <pre id="diagPanel"></pre>
  </div>

<script>
const API = (window.BITDASH_API_URL || 'https://bitdash-api.crlages.workers.dev').replace(/\/$/, '');

const DIAG = new URL(location.href).searchParams.get('diag') === '1' || localStorage.getItem('bitdash_diag') === '1';
if (new URL(location.href).searchParams.get('diag') === '1') { try { localStorage.setItem('bitdash_diag','1'); } catch {} }
function parseTokenLocal(){
  try {
    const token = String(localStorage.getItem('bitdash_auth_token') || '').trim();
    if (!token) return { tokenPresent:false };
    const body = token.split('.')[0] || '';
    const b64 = body.replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
    const payload = JSON.parse(atob(b64 + pad));
    return {
      tokenPresent:true,
      email: payload?.email || null,
      expIso: payload?.exp ? new Date(Number(payload.exp)).toISOString() : null,
      expired: payload?.exp ? Date.now() > Number(payload.exp) : null,
      len: token.length,
    };
  } catch (e) { return { tokenPresent:true, parseError:String(e.message||e) }; }
}
function renderDiag(extra={}){
  if (!DIAG) return;
  const el = document.getElementById('diagPanel');
  if (!el) return;
  el.classList.add('show');
  const base = {
    page: location.pathname,
    api: API,
    ts: new Date().toISOString(),
    localUser: localStorage.getItem('bitdash_local_user') || null,
    ...parseTokenLocal(),
    ...extra,
  };
  el.textContent = '[BITDASH DIAG]\n' + JSON.stringify(base, null, 2);
}
const GOOGLE_CLIENT_ID = '90657228527-vg76ohma7rj6pkpc7p9sk4spk13dlbc1.apps.googleusercontent.com'; // Client ID Web do Google Cloud

const statusEl = document.getElementById('status');

async function api(path, method='GET', body){
  try {
    const token = localStorage.getItem('bitdash_auth_token') || '';
    const headers = {'Content-Type':'application/json'};
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const r = await fetch(API+path, {
      method,
      headers,
      body: body ? JSON.stringify(body) : undefined,
    });
    let j={}; try{ j=await r.json(); }catch{}
    if(!r.ok || j.ok===false) { renderDiag({ apiPath:path, apiStatus:r.status, apiOk:false, apiError:j.error || `http_${r.status}` }); throw new Error(j.error || `http_${r.status}`); }
    return j;
  } catch (e) {
    throw e;
  }
}

async function routeByPremium(email, premium, token){
  // fluxo único: sempre entra no dashboard após login
  const q = token ? ('?st=' + encodeURIComponent(token)) : '';
  location.href = 'commercial-dashboard.html' + q;
}

async function checkExistingLogin(){
  // desativado para evitar redirecionamento automático/flicker
}

async function loginWithGoogleCredential(credential){
  try {
    const j = await api('/auth/google','POST',{ credential });
    const email = j?.user?.email || '';
    const token = j?.token || '';
    if (token) localStorage.setItem('bitdash_auth_token', token);
    renderDiag({ stage:'after-google-login', loginEmail: email || null, tokenReturned: !!token });
    if (email) localStorage.setItem('bitdash_local_user', email);
    statusEl.textContent = 'Login Google OK. Verificando assinatura...';
    setTimeout(()=>routeByPremium(email, !!j?.premium, token), 120);
  } catch (e) {
    if (String(e.message || '').toLowerCase().includes('fetch')) {
      statusEl.textContent = `Google login falhou: não consegui conectar na API (${API}).`;
      return;
    }
    statusEl.textContent = `Google login falhou: ${e.message}`;
    renderDiag({ stage:'google-login-error', error: String(e.message||e) });
  }
}

function initGoogleLogin(attempt = 0){
  const wrap = document.getElementById('googleWrap');
  if (!GOOGLE_CLIENT_ID) {
    wrap.innerHTML = '<span class="muted">Login Google aguardando configuração do Client ID.</span>';
    return;
  }

  if (!window.google?.accounts?.id) {
    // injeta SDK dinamicamente para reduzir problemas de carregamento assíncrono
    if (!document.getElementById('google-gsi-sdk')) {
      const s = document.createElement('script');
      s.id = 'google-gsi-sdk';
      s.src = 'https://accounts.google.com/gsi/client';
      s.async = true;
      s.defer = true;
      s.onload = () => initGoogleLogin(0);
      s.onerror = () => {
        wrap.innerHTML = '<span class="muted">Falha ao carregar SDK Google (rede/bloqueio).</span>';
      };
      document.head.appendChild(s);
    }

    if (attempt < 30) {
      wrap.innerHTML = '<span class="muted">Carregando login Google...</span>';
      setTimeout(() => initGoogleLogin(attempt + 1), 250);
      return;
    }

    wrap.innerHTML = '<span class="muted">SDK do Google não carregou. Verifique bloqueador/privacidade do navegador.</span>';
    return;
  }

  window.google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    auto_select: false,
    callback: (resp) => loginWithGoogleCredential(resp.credential),
  });

  wrap.innerHTML = '';
  window.google.accounts.id.renderButton(wrap, {
    type: 'standard',
    theme: 'outline',
    size: 'large',
    text: 'signin_with',
    shape: 'pill',
  });

  // sem prompt automático para evitar navegação involuntária
}

renderDiag({ stage:'auth-init' });
initGoogleLogin();
</script>
</body>
</html>
