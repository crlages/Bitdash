<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitdash • Dashboard</title>
  <style>
    body{margin:0;background:#0b1020;color:#e8edff;font-family:Inter,Segoe UI,Arial}
    .wrap{max-width:1080px;margin:20px auto;padding:16px}
    .card{background:#121a33;border:1px solid #2b3d72;border-radius:14px;padding:16px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{background:#1b2d5e;color:#fff;border:1px solid #3d58a6;border-radius:9px;padding:8px 12px;cursor:pointer}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #233565;padding:8px;text-align:left}
    .muted{color:#9aa7d8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span id="guestBadge" class="muted" style="font-size:.9rem;border:1px solid #3d58a6;padding:4px 8px;border-radius:999px;display:none">Modo convidado (local)</span>
        <h2 style="margin:0">Bitdash Dashboard</h2>
        <div class="row">
          <button id="addBtn">+ Adicionar ativos</button>
          <button id="clearBtn">Limpar carteira</button>
          <button id="logoutBtn">Sair</button>
          <button id="authBtn">Login Premium</button>
        </div>
      </div>
      <div id="status" class="muted" style="margin-top:8px">Inicializando...</div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Carteira</h3>
      <table>
        <thead><tr><th>Ativo</th><th>Qtd</th><th>Classe</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
const API = 'https://bitdash-api.crlages.workers.dev';
let portfolio = [];
function normalizeTicker(t){ return String(t||'').trim().toUpperCase(); }

function parseToken(){
  try {
    const token = String(localStorage.getItem('bitdash_auth_token') || '').trim();
    if (!token) return null;
    const body = token.split('.')[0] || '';
    const b64 = body.replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
    const payload = JSON.parse(atob(b64 + pad));
    if (!payload?.email) return null;
    if (payload?.exp && Date.now() > Number(payload.exp)) return null;
    return payload;
  } catch { return null; }
}

function sessionEmail(){
  const p = parseToken();
  if (p?.email) return String(p.email).toLowerCase();
  return String(localStorage.getItem('bitdash_local_user') || '').trim().toLowerCase() || null;
}

function setAuthUi(){
  const email = sessionEmail();
  document.getElementById('authBtn').textContent = email ? `Premium: ${email}` : 'Login Premium (modo convidado)';
}

function updateGuestBadge(){
  const b = document.getElementById('guestBadge');
  if (!b) return;
  b.style.display = parseToken() ? 'none' : 'inline-flex';
}

async function api(path, method='GET', body){
  const token = localStorage.getItem('bitdash_auth_token') || '';
  const headers = {'Content-Type':'application/json'};
  if (token) headers.Authorization = `Bearer ${token}`;
  const r = await fetch(API + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  const j = await r.json().catch(()=>({}));
  if (j?.token) localStorage.setItem('bitdash_auth_token', j.token);
  if (!r.ok || j.ok === false) throw new Error(j.error || `http_${r.status}`);
  return j;
}

function mergeByTicker(base=[], incoming=[]){
  const m = new Map();
  for (const a of (base||[])) { const t=normalizeTicker(a.ticker); const q=Number(a.qty||0); if(t&&q>0) m.set(t,{ticker:t,qty:q,cls:a.cls || (String(t).endsWith('11') ? 'FII' : 'AÇÃO')}); }
  for (const a of (incoming||[])) { const t=normalizeTicker(a.ticker); const q=Number(a.qty||0); if(!t||q<=0) continue; const prev=m.get(t); m.set(t,{ticker:t,qty:q,cls:a.cls || (String(t).endsWith('11') ? 'FII' : 'AÇÃO')}); }
  return [...m.values()];
}

function readInbound(){
  try {
    const raw = localStorage.getItem('bitdash_inbound_portfolio') || '';
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}

function clearInbound(){
  try { localStorage.removeItem('bitdash_inbound_portfolio'); } catch {}
}

function render(){
  setAuthUi();
updateGuestBadge();
  const rows = document.getElementById('rows');
  rows.innerHTML = '';
  for (const a of portfolio){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.ticker}</td><td>${a.qty}</td><td>${a.cls || '-'}</td>`;
    rows.appendChild(tr);
  }
  if (!portfolio.length){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="3" class="muted">Carteira vazia</td>';
    rows.appendChild(tr);
  }
}

async function loadPortfolio(){
  const st = document.getElementById('status');
  try {
    if (!parseToken()) {
      const cached = JSON.parse(localStorage.getItem('bitdash_portfolio_cache') || '[]');
      portfolio = Array.isArray(cached) ? cached : [];
      const inbound = readInbound();
      if (inbound.length) { portfolio = mergeByTicker(portfolio, inbound); clearInbound(); localStorage.setItem('bitdash_portfolio_cache', JSON.stringify(portfolio)); }
      st.textContent = 'Modo convidado: carteira local carregada.';
      render();
      return;
    }
    const j = await api('/portfolio');
    portfolio = Array.isArray(j.portfolio) ? j.portfolio : [];
    const inbound = readInbound();
    if (inbound.length) {
      portfolio = mergeByTicker(portfolio, inbound);
      clearInbound();
      try { await api('/portfolio','POST',{ portfolio }); } catch {}
    }
    localStorage.setItem('bitdash_portfolio_cache', JSON.stringify(portfolio));
    st.textContent = 'Carteira carregada.';
  } catch (e) {
    const cached = JSON.parse(localStorage.getItem('bitdash_portfolio_cache') || '[]');
    portfolio = Array.isArray(cached) ? cached : [];
    const inbound = readInbound();
    if (inbound.length) { portfolio = mergeByTicker(portfolio, inbound); clearInbound(); localStorage.setItem('bitdash_portfolio_cache', JSON.stringify(portfolio)); }
    st.textContent = 'Falha ao carregar da nuvem, exibindo cache local: ' + (e.message || e);
  }
  render();
}

document.getElementById('authBtn').onclick = ()=> location.href='commercial-auth.html';
document.getElementById('addBtn').onclick = ()=> location.href='commercial-add-assets.html';
document.getElementById('logoutBtn').onclick = async ()=>{
  try { await api('/auth/logout','POST',{}); } catch {}
  localStorage.removeItem('bitdash_auth_token');
  localStorage.removeItem('bitdash_local_user');
  location.href='commercial-auth.html';
};
document.getElementById('clearBtn').onclick = async ()=>{
  if (!confirm('Limpar carteira?')) return;
  portfolio = [];
  localStorage.setItem('bitdash_portfolio_cache', '[]');
  render();
  if (!parseToken()) { document.getElementById('status').textContent='Carteira local limpa (modo convidado).'; return; }
  try { await api('/portfolio','POST',{ portfolio: [] }); document.getElementById('status').textContent='Carteira limpa.'; }
  catch (e){ document.getElementById('status').textContent='Limpa local, falha nuvem: ' + (e.message||e); }
};

loadPortfolio();
setAuthUi();
</script>
</body>
</html>