<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Adicionar Ativos</title>
  <style>
    body{margin:0;background:#0b1020;color:#e8edff;font-family:Inter,Segoe UI,Arial;padding:20px}
    .muted{color:#9aa7d8}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .card{background:#121a33;border:1px solid #2b3d72;border-radius:14px;padding:14px}
    textarea{width:100%;min-height:240px;background:#0f1731;color:#fff;border:1px solid #334a87;border-radius:10px;padding:10px;font-family:Consolas,monospace}
    button{background:#1b2d5e;color:#fff;border:1px solid #3d58a6;border-radius:9px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:.94rem;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #243566;text-align:left}
    th{color:#9aa7d8}
    .ok{color:#8ef0b7}.bad{color:#ffb1b1}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.82rem}
    .pill.ok{background:rgba(53,208,127,.16)} .pill.bad{background:rgba(255,107,107,.18)}
    .tooltip-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .info-dot{
      width:20px;height:20px;border-radius:999px;border:1px solid #4f6fc7;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:700;font-size:.8rem;color:#bcd0ff;background:#1a2a57;cursor:help;
      user-select:none;
    }
    .tooltip{
      position:absolute;top:26px;left:0;z-index:10;width:min(420px,75vw);
      background:#0f1731;border:1px solid #3b56a2;border-radius:10px;padding:10px;
      color:#dce6ff;font-size:.88rem;line-height:1.35;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35);
      white-space:normal;
    }
    .tooltip-wrap:hover .tooltip,.tooltip-wrap.open .tooltip{display:block}
  
    #diagPanel{margin-top:12px;padding:10px;border:1px dashed #3d58a6;border-radius:10px;background:#0a132e;color:#bcd0ff;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;display:none}
    #diagPanel.show{display:block}
    </style>
</head>
<body>
  <div class="topbar">
    <h1 style="margin:0">Adicionar novos ativos</h1>
    <div class="top-actions">
      <button id="loginTopBtn">Login Premium</button>
      <button id="clearTopBtn">Limpar carteira</button>
      <button id="logoutTopBtn" class="hidden">Sair</button>
    </div>
  </div>

  <div class="row" style="margin-bottom:10px;">
    <div class="muted"><strong>Suporta apenas ativos da B3</strong></div>
    <div class="tooltip-wrap" id="infoTip" aria-label="Informações de tipos de ativos da B3">
      <span class="info-dot">i</span>
      <div class="tooltip">
        <strong>Tipos de Ativos B3:</strong><br/>
        Ações: Parte do capital social de uma empresa.<br/>
        FIIs: Fundos de Investimento Imobiliário.<br/>
        ETFs: Exchange Traded Funds (fundos de índice).<br/>
        BDRs: Brazilian Depositary Receipts (ações estrangeiras negociadas no Brasil).<br/>
        Derivativos: Contratos futuros e opções (dólar, índice, commodities).
      </div>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <h3 style="margin-top:0">1) Inserir ativos</h3>
      <div class="muted">Ex.: <code>PETR4 20 MXRF11 120 BOVA11 10 AAPL34 15 WDOFUT 2</code></div>
      <textarea id="raw" placeholder="Cole os ativos aqui..."></textarea>
      <div class="row" style="margin-top:10px;">
        <button id="analyzeBtn">Avaliar ativos</button>
        <button onclick="location.href='commercial-dashboard.html'">Voltar sem salvar</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">2) Pré-avaliação</h3>
      <div class="row" style="margin-bottom:8px;">
        <span class="pill ok" id="okCount">Válidos: 0</span>
        <span class="pill bad" id="badCount">Reprovados: 0</span>
      </div>
      <table>
        <thead><tr><th>Ticker</th><th>Qtd</th><th>Tipo</th><th>Status</th><th>Motivo</th></tr></thead>
        <tbody id="reviewRows"></tbody>
      </table>
      <div class="row" style="margin-top:10px;">
        <button id="confirmBtn" disabled>Confirmar e enviar para precificação</button>
      </div>
    </div>
  <pre id="diagPanel"></pre>
  </div>

<script>
const API = (window.BITDASH_API_URL || 'https://bitdash-api.crlages.workers.dev').replace(/\/$/, '');

const DIAG = new URL(location.href).searchParams.get('diag') === '1' || localStorage.getItem('bitdash_diag') === '1';
if (new URL(location.href).searchParams.get('diag') === '1') { try { localStorage.setItem('bitdash_diag','1'); } catch {} }
function parseTokenLocal(){
  try {
    const token = String(localStorage.getItem('bitdash_auth_token') || '').trim();
    if (!token) return { tokenPresent:false };
    const body = token.split('.')[0] || '';
    const b64 = body.replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
    const payload = JSON.parse(atob(b64 + pad));
    return {
      tokenPresent:true,
      email: payload?.email || null,
      expIso: payload?.exp ? new Date(Number(payload.exp)).toISOString() : null,
      expired: payload?.exp ? Date.now() > Number(payload.exp) : null,
      len: token.length,
    };
  } catch (e) { return { tokenPresent:true, parseError:String(e.message||e) }; }
}
function renderDiag(extra={}){
  if (!DIAG) return;
  const el = document.getElementById('diagPanel');
  if (!el) return;
  el.classList.add('show');
  const base = {
    page: location.pathname,
    api: API,
    ts: new Date().toISOString(),
    localUser: localStorage.getItem('bitdash_local_user') || null,
    ...parseTokenLocal(),
    ...extra,
  };
  el.textContent = '[BITDASH DIAG]\n' + JSON.stringify(base, null, 2);
}

function bootstrapSessionFromUrl(){
  try {
    const u = new URL(location.href);
    const st = String(u.searchParams.get('st') || '').trim();
    if (st) {
      localStorage.setItem('bitdash_auth_token', st);
      u.searchParams.delete('st');
      history.replaceState({}, '', u.pathname + (u.search ? '?' + u.searchParams.toString() : '') + (u.hash || ''));
    }
  } catch {}
}
function normalizeTicker(t){ return String(t||'').trim().toUpperCase(); }

async function api(path, method='GET', body){
  const token = localStorage.getItem('bitdash_auth_token') || '';
  const headers = {'Content-Type':'application/json'};
  if (token) headers['Authorization'] = `Bearer ${token}`;

  const r = await fetch(API+path, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });
  let j={}; try{ j=await r.json(); }catch{}
  if (j?.token) { try { localStorage.setItem('bitdash_auth_token', j.token); } catch {} }
  if(!r.ok || j.ok===false) { renderDiag({ apiPath:path, apiStatus:r.status, apiOk:false, apiError:j.error || `http_${r.status}` }); throw new Error(j.error || `http_${r.status}`); }
  renderDiag({ apiPath:path, apiStatus:r.status, apiOk:true });
  return j;
}


function parseLocalSession(){
  try {
    const token = String(localStorage.getItem('bitdash_auth_token') || '').trim();
    if (!token) return null;
    const body = token.split('.')[0] || '';
    if (!body) return null;
    const b64 = body.replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
    const payload = JSON.parse(atob(b64 + pad));
    if (!payload?.email) return null;
    if (payload?.exp && Date.now() > Number(payload.exp)) return null;
    return { email: String(payload.email).toLowerCase(), name: payload.name || null };
  } catch { return null; }
}

function getLocalPremiumEmail(){
  const e = String(localStorage.getItem('bitdash_local_user') || '').trim().toLowerCase();
  return e || null;
}

async function updateTopAuthState(){
  const loginBtn = document.getElementById('loginTopBtn');
  const logoutBtn = document.getElementById('logoutTopBtn');
  const s = parseLocalSession();
  if (s?.email) {
    loginBtn.textContent = `Premium: ${s.email}`;
    logoutBtn.classList.remove('hidden');
    return true;
  }
  loginBtn.textContent = 'Login Premium';
  logoutBtn.classList.add('hidden');
  return false;
}


function classifyB3(ticker){
  // Fundos listados (FII/FIAGRO/alguns fundos de índice) costumam terminar em 11
  if (/^[A-Z0-9]{4,10}11$/.test(ticker)) {
    const etfKnown = new Set(['BOVA11','SMAL11','IVVB11','DIVO11','XFIX11','GOVE11','SPXI11','XBOV11','FIND11']);
    if (etfKnown.has(ticker)) return 'ETF';
    return 'FUNDO';
  }

  // Ações (ex: PETR4, WEGE3)
  if (/^[A-Z]{4}(3|4|5|6)$/.test(ticker)) return 'AÇÃO';

  // BDRs (ex: AAPL34, MSFT34)
  if (/^[A-Z]{4,6}\d{2}$/.test(ticker)) return 'BDR';

  // Derivativos (padrões simplificados para opções/futuros)
  if (/^[A-Z]{4}[A-X]\d{1,2}$/.test(ticker)) return 'DERIVATIVO';
  if (/^(WDO|WIN|DOL|IND)[A-Z0-9]{1,6}$/.test(ticker)) return 'DERIVATIVO';

  return null;
}

function parseRaw(text){
  const up = String(text||'').toUpperCase().replace(/[\n\t;]+/g,' ');
  const re = /\b([A-Z]{2,12}\d{0,3})\b\s+(\d{1,9}(?:[\.,]\d+)?)\b/g;
  const map = new Map();
  let m;
  while((m=re.exec(up))!==null){
    const ticker = normalizeTicker(m[1]);
    const qty = Number(String(m[2]).replace(',', '.'));
    if (!Number.isFinite(qty) || qty <= 0) continue;
    map.set(ticker, (map.get(ticker)||0) + qty);
  }
  return [...map.entries()].map(([ticker, qty]) => ({ ticker, qty }));
}

function validateAsset(item){
  const type = classifyB3(item.ticker);
  if (!type) {
    return { ...item, type: '-', ok:false, reason:'Ticker fora dos tipos suportados da B3.' };
  }
  return { ...item, type, ok:true, reason:'Aprovado para carteira e precificação.' };
}

function mapUniverseTypeToLocal(assetType){
  const t = String(assetType || '').toUpperCase();
  if (t === 'FUNDO') return 'FUNDO';
  if (t === 'ACAO') return 'AÇÃO';
  if (t === 'BDR') return 'BDR';
  return null;
}

async function validateWithUniverse(item){
  try {
    const j = await api(`/assets/search?q=${encodeURIComponent(item.ticker)}&limit=3`);
    const rows = Array.isArray(j.items) ? j.items : [];
    const exact = rows.find(r => String(r.ticker || '').toUpperCase() === item.ticker);
    if (exact) {
      const type = mapUniverseTypeToLocal(exact.asset_type) || classifyB3(item.ticker) || '-';
      return { ...item, type, ok: true, reason: 'Validado no universo B3.' };
    }
  } catch {}
  return validateAsset(item);
}

let approvedItems = [];

function mergeByTicker(base=[], incoming=[]){
  const m = new Map();
  for (const a of base) {
    const t = normalizeTicker(a.ticker);
    const qty = Number(a.qty || 0);
    if (!t || !Number.isFinite(qty) || qty <= 0) continue;
    m.set(t, { ticker:t, qty, cls: mapTypeToDashboardClass(classifyB3(t) || 'AÇÃO') });
  }
  for (const a of incoming) {
    const t = normalizeTicker(a.ticker);
    const qty = Number(a.qty || 0);
    if (!t || !Number.isFinite(qty) || qty <= 0) continue;
    const prev = m.get(t);
    const nextQty = (prev?.qty || 0) + qty;
    m.set(t, { ticker:t, qty: nextQty, cls: mapTypeToDashboardClass(classifyB3(t) || 'AÇÃO') });
  }
  return [...m.values()];
}

function mapTypeToDashboardClass(type){
  // dashboard atual trabalha melhor com AÇÃO/FII
  if (type === 'FUNDO' || type === 'FII' || type === 'ETF') return 'FII';
  return 'AÇÃO';
}

function renderReview(rows){
  const tbody = document.getElementById('reviewRows');
  tbody.innerHTML = '';

  let ok = 0, bad = 0;
  for (const r of rows) {
    if (r.ok) ok++; else bad++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${r.ticker}</strong></td>
      <td>${Number(r.qty).toLocaleString('pt-BR',{maximumFractionDigits:8})}</td>
      <td>${r.type}</td>
      <td class="${r.ok?'ok':'bad'}"><strong>${r.ok?'APROVADO':'REPROVADO'}</strong></td>
      <td>${r.reason}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('okCount').textContent = `Válidos: ${ok}`;
  document.getElementById('badCount').textContent = `Reprovados: ${bad}`;
  document.getElementById('confirmBtn').disabled = ok === 0;

  approvedItems = rows.filter(x=>x.ok).map(x=>({ ticker:x.ticker, qty:x.qty, cls:mapTypeToDashboardClass(x.type) }));
}

document.getElementById('analyzeBtn').onclick = async () => {
  const raw = document.getElementById('raw').value || '';
  const parsed = parseRaw(raw);
  const status = document.getElementById('status');

  if (!parsed.length) {
    status.textContent = 'Nada reconhecido. Use padrão: TICKER + quantidade.';
    renderReview([]);
    return;
  }

  status.textContent = 'Validando no universo B3...';
  const reviewed = await Promise.all(parsed.map(validateWithUniverse));
  renderReview(reviewed);
  status.textContent = 'Pré-avaliação concluída. Confirme para enviar apenas os aprovados.';
};

document.getElementById('confirmBtn').onclick = async () => {
  const status = document.getElementById('status');
  try {
    if (!approvedItems.length) {
      status.textContent = 'Nenhum ativo aprovado para envio.';
      return;
    }

    // Base determinística: snapshot da carteira atual (vindo do dashboard) + fallback sessão
    let base = [];
    try {
      const snap = JSON.parse(sessionStorage.getItem('bitdash_portfolio_snapshot') || 'null');
      if (Array.isArray(snap)) base = snap;
    } catch {}
    if (!base.length) {
      try {
        const snapLocal = JSON.parse(localStorage.getItem('bitdash_portfolio_snapshot') || 'null');
        if (Array.isArray(snapLocal)) base = snapLocal;
      } catch {}
    }
    if (!base.length) {
      try {
        const freeRaw = sessionStorage.getItem('freePortfolio');
        const free = freeRaw ? JSON.parse(freeRaw) : [];
        if (Array.isArray(free)) base = free;
      } catch {}
    }

    const merged = mergeByTicker(base, approvedItems);
    const payload = JSON.stringify(merged);

    try { sessionStorage.setItem('inboundPortfolio', payload); } catch {}
    try { localStorage.setItem('bitdash_inbound_portfolio', payload); } catch {}
    try { localStorage.setItem('bitdash_portfolio_draft', payload); } catch {}
    try { localStorage.removeItem('bitdash_portfolio_cleared'); } catch {}

    // remoto com erro explícito quando houver sessão local
    const sess = parseLocalSession();
    if (sess?.email) {
      await api('/portfolio','POST',{ portfolio: merged });
      status.textContent = 'Ativos adicionados e carteira salva na nuvem.';
    } else {
      status.textContent = 'Ativos adicionados localmente (sem login premium ativo).';
    }

    location.href='commercial-dashboard.html';
  } catch (e) {
    status.textContent = 'Falha ao confirmar ativos: ' + (e.message || e);
  }
};



document.getElementById('loginTopBtn').onclick = ()=>{ location.href='commercial-auth.html'; };
document.getElementById('logoutTopBtn').onclick = async ()=>{
  try { await api('/auth/logout','POST',{}); } catch {}
  try { localStorage.removeItem('bitdash_local_user'); } catch {}
  try { localStorage.removeItem('bitdash_auth_token'); } catch {}
  alert('Sessão encerrada.');
};
document.getElementById('clearTopBtn').onclick = async ()=>{
  const ok = confirm('Tem certeza que deseja limpar a carteira?');
  if (!ok) return;
  const sess = parseLocalSession();
  if (sess?.email) {
    try {
      await api('/portfolio','POST',{ portfolio: [] });
      try { localStorage.setItem('bitdash_portfolio_draft', JSON.stringify([])); } catch {}
      try { localStorage.setItem('bitdash_portfolio_cleared', '1'); } catch {}
      alert('Carteira limpa com sucesso.');
      return;
    } catch (e) {
      alert('Falha ao limpar na nuvem: ' + (e.message || e));
    }
  }
  try { sessionStorage.setItem('freePortfolio', JSON.stringify([])); } catch {}
  try { localStorage.setItem('bitdash_portfolio_draft', JSON.stringify([])); } catch {}
  try { localStorage.setItem('bitdash_portfolio_cleared', '1'); } catch {}
  alert('Carteira limpa localmente.');
};

bootstrapSessionFromUrl();
renderDiag({ stage:'add-init' });
(async ()=>{
  updateTopAuthState();
  try { const me = await api('/auth/me'); renderDiag({ stage:'add-auth-me', meOk: !!me?.ok, meEmail: me?.user?.email || null }); } catch(e){ renderDiag({ stage:'add-auth-me-fail', err:String(e.message||e) }); }
})();

// Tooltip também no clique (mobile/touch)
(function(){
  const tip = document.getElementById('infoTip');
  if (!tip) return;

  tip.addEventListener('click', (e) => {
    e.stopPropagation();
    tip.classList.toggle('open');
  });

  document.addEventListener('click', (e) => {
    if (!tip.contains(e.target)) tip.classList.remove('open');
  });
})();

// sincroniza universo B3 no máximo 1x por dia (sem bloquear a tela)
(async function syncUniverseOnceDaily(){
  try {
    const key = 'bitdash_assets_universe_sync_at';
    const last = Number(localStorage.getItem(key) || 0);
    const now = Date.now();
    if ((now - last) < 24*60*60*1000) return;
    await api('/assets/sync', 'POST', {});
    localStorage.setItem(key, String(now));
  } catch {}
})();

</script>
</body>
</html>
