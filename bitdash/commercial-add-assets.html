<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitdash • Adicionar Ativos</title>
  <style>
    body{margin:0;background:#0b1020;color:#e8edff;font-family:Inter,Segoe UI,Arial}
    .wrap{max-width:900px;margin:20px auto;padding:16px}
    .card{background:#121a33;border:1px solid #2b3d72;border-radius:14px;padding:16px}
    textarea{width:100%;min-height:120px;background:#0c1430;color:#e8edff;border:1px solid #2c3f73;border-radius:10px;padding:10px}
    button{background:#1b2d5e;color:#fff;border:1px solid #3d58a6;border-radius:9px;padding:8px 12px;cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:#9aa7d8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin-top:0">Adicionar Ativos</h2>
      <p class="muted">Exemplos: <code>PETR4 1</code>, <code>1 PETR4</code>, <code>PETR4</code></p>
      <textarea id="raw" placeholder="Digite aqui"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="confirmBtn">Confirmar e salvar</button>
        <button onclick="location.href='commercial-dashboard.html'">Voltar</button>
      </div>
      <div id="status" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

<script>
const API = 'https://bitdash-api.crlages.workers.dev';

function normalizeTicker(t){ return String(t||'').trim().toUpperCase(); }
function classify(t){ return t.endsWith('11') ? 'FII' : 'AÇÃO'; }

function parseRaw(text){
  const norm = String(text||'').toUpperCase().replace(/[;\n\t]+/g,' ').replace(/,/g,'.');
  const map = new Map();
  const add = (ticker, qRaw)=>{
    const t = normalizeTicker(ticker); const q = Number(String(qRaw).replace(',', '.'));
    if (!t || !Number.isFinite(q) || q <= 0) return;
    map.set(t, (map.get(t)||0) + q);
  };
  let m;
  const re1 = /\b([A-Z]{2,12}\d{0,3})\b\s+(\d{1,9}(?:[\.,]\d+)?)\b/g; // TICKER QTD
  while((m=re1.exec(norm))!==null) add(m[1], m[2]);
  const re2 = /\b(\d{1,9}(?:[\.,]\d+)?)\b\s+([A-Z]{2,12}\d{0,3})\b/g; // QTD TICKER
  while((m=re2.exec(norm))!==null) add(m[2], m[1]);
  if (map.size === 0){
    const tk = norm.match(/\b([A-Z]{2,12}\d{0,3})\b/);
    if (tk) add(tk[1], 1);
  }
  return [...map.entries()].map(([ticker, qty]) => ({ ticker, qty, cls: classify(ticker) }));
}

function mergeByTicker(base=[], incoming=[]){
  const m = new Map();
  for (const a of base){ const t=normalizeTicker(a.ticker); const q=Number(a.qty||0); if(t&&q>0) m.set(t,{ticker:t,qty:q,cls:classify(t)}); }
  for (const a of incoming){ const t=normalizeTicker(a.ticker); const q=Number(a.qty||0); if(!t||q<=0) continue; const prev=m.get(t); m.set(t,{ticker:t,qty:q,cls:classify(t)}); }
  return [...m.values()];
}

async function api(path, method='GET', body){
  const token = localStorage.getItem('bitdash_auth_token') || '';
  const headers = {'Content-Type':'application/json'};
  if (token) headers.Authorization = `Bearer ${token}`;
  const r = await fetch(API + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j.ok === false) throw new Error(j.error || `http_${r.status}`);
  return j;
}

async function loadBasePortfolio(){
  try {
    const j = await api('/portfolio');
    if (Array.isArray(j.portfolio)) return j.portfolio;
  } catch {}
  try {
    const c = JSON.parse(localStorage.getItem('bitdash_portfolio_cache') || '[]');
    if (Array.isArray(c)) return c;
  } catch {}
  return [];
}

document.getElementById('confirmBtn').onclick = async ()=>{
  const st = document.getElementById('status');
  try {
    const parsed = parseRaw(document.getElementById('raw').value || '');
    if (!parsed.length) {
      st.textContent = 'Nada reconhecido. Use exemplo: PETR4 1';
      return;
    }
    const base = await loadBasePortfolio();
    const merged = mergeByTicker(base, parsed);

    // sempre aplica local primeiro
    localStorage.setItem('bitdash_portfolio_cache', JSON.stringify(merged));
    localStorage.setItem('bitdash_inbound_portfolio', JSON.stringify(parsed));

    // tenta nuvem (aguarda curto); se falhar, dashboard consolida pelo inbound
    try {
      if (localStorage.getItem('bitdash_auth_token')) {
        await Promise.race([
          api('/portfolio','POST',{ portfolio: merged }),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error('sync_timeout')), 1800))
        ]);
      }
    } catch {}

    st.textContent = 'Ativos adicionados com sucesso.';
    setTimeout(()=>location.href='commercial-dashboard.html', 350);
  } catch (e) {
    st.textContent = 'Falha ao adicionar: ' + (e.message || e);
  }
};
</script>
</body>
</html>