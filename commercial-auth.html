<!doctype html>
<html lang="pt-BR"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Premium</title>
<style>
body{margin:0;background:#0b1020;color:#e8edff;font-family:Inter,Segoe UI,Arial;padding:20px}
.card{background:#121a33;border:1px solid #2b3d72;border-radius:14px;padding:14px;max-width:620px}
input{width:100%;padding:9px;margin:6px 0;border-radius:9px;border:1px solid #3a5194;background:#0f1731;color:#fff}
button{background:#1b2d5e;color:#fff;border:1px solid #3d58a6;border-radius:9px;padding:8px 12px;cursor:pointer}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.muted{color:#9aa7d8}
</style></head><body>
<h1 style="margin-top:0">Cadastro/Login Premium</h1>
<div class="card">
  <div class="muted">Etapa 1: cadastre e gere sua contra senha. Etapa 2 será em tela separada.</div>
  <input id="email" placeholder="E-mail"/>
  <input id="pass" type="password" placeholder="Senha (mínimo 6 caracteres)"/>
    <div class="row" style="margin-top:10px;">
    <button id="register">1) Cadastrar e gerar contra senha</button>
    <button id="login">Entrar</button>
    <button onclick="location.href='commercial-dashboard.html'">Voltar</button>
  </div>
  <div id="status" class="muted" style="margin-top:10px;"></div>
</div>
<script>
const API_HOST = (!location.hostname || ['localhost','127.0.0.1'].includes(location.hostname)) ? '192.168.1.105' : location.hostname;
const API_PROTO = location.protocol === 'file:' ? 'http:' : location.protocol;
const API = `${API_PROTO}//${API_HOST}:8001`;
const statusEl=document.getElementById('status');
statusEl.textContent = `Conectando em: ${API}`;
const emailEl=document.getElementById('email');
const params = new URLSearchParams(location.search);
emailEl.value = params.get('email') || '';
const passEl=document.getElementById('pass');

async function api(path, method='GET', body){
  try {
    const r = await fetch(API+path, {
      method,
      headers: {'Content-Type':'application/json'},
      credentials: 'include',
      body: body ? JSON.stringify(body) : undefined,
    });
    let j={}; try{ j=await r.json(); }catch{}
    if(!r.ok || j.ok===false) throw new Error(j.error || `http_${r.status}`);
    return j;
  } catch (e) {
    // fallback local quando API estiver indisponível
    const users = JSON.parse(localStorage.getItem('bitdash_users')||'{}');
    if (path==='/auth/register' && method==='POST') {
      const code = String(Math.floor(100000 + Math.random()*900000));
      users[body.email] = { password: body.password, verified: false, code };
      localStorage.setItem('bitdash_users', JSON.stringify(users));
      return { ok:true, devCode: code };
    }
    if (path==='/auth/login' && method==='POST') {
      const u = users[body.email];
      if (!u) throw new Error('invalid_credentials');
      if (!u.verified) throw new Error('email_not_verified');
      if (u.password !== body.password) throw new Error('invalid_credentials');
      localStorage.setItem('bitdash_local_user', body.email);
      return { ok:true };
    }
    throw e;
  }
}

document.getElementById('register').onclick = async ()=>{
  const email=emailEl.value.trim().toLowerCase();
  const password=passEl.value;
  if(!email || password.length<6){ statusEl.textContent='Preencha e-mail e senha válida.'; return; }
  try{
    const j = await api('/auth/register','POST',{email,password});
    // Local dev: código aparece aqui para teste
    location.href = `commercial-verify.html?email=${encodeURIComponent(email)}&devCode=${encodeURIComponent(j.devCode||'')}`;
  }catch(e){ statusEl.textContent = `Erro no cadastro: ${e.message}`; }
};

document.getElementById('login').onclick = async ()=>{
  const email=emailEl.value.trim().toLowerCase();
  const password=passEl.value;
  try{
    await api('/auth/login','POST',{email,password});
    statusEl.textContent = 'Login OK. Redirecionando...';
    setTimeout(()=>location.href='commercial-dashboard.html',700);
  }catch(e){ statusEl.textContent = `Erro no login: ${e.message}`; }
};
</script>
</body></html>