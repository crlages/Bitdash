<!doctype html>
<html lang="pt-BR"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Login Premium</title>
<style>
body{margin:0;background:#0b1020;color:#e8edff;font-family:Inter,Segoe UI,Arial;padding:20px}
.card{background:#121a33;border:1px solid #2b3d72;border-radius:14px;padding:14px;max-width:760px}
input{width:100%;padding:9px;margin:6px 0;border-radius:9px;border:1px solid #3a5194;background:#0f1731;color:#fff}
button,a.btn{background:#1b2d5e;color:#fff;border:1px solid #3d58a6;border-radius:9px;padding:8px 12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.muted{color:#9aa7d8}
</style></head><body>
<h1 style="margin-top:0">Login Premium</h1>
<div class="card">
  <div class="muted">Entre com e-mail e senha. Se você ainda não tem cadastro premium, será direcionado para o pagamento.</div>
  <input id="email" placeholder="E-mail"/>
  <input id="pass" type="password" placeholder="Senha"/>

  <div class="row" style="margin-top:10px;">
    <button id="login">Entrar</button>
    <a class="btn" id="payBtn" href="commercial-premium-payment.html">Ainda não tenho cadastro premium</a>
    <button onclick="location.href='commercial-dashboard.html'">Voltar</button>
  </div>
  <div id="status" class="muted" style="margin-top:10px;"></div>
</div>
<script>
const API_HOST = (!location.hostname || ['localhost','127.0.0.1'].includes(location.hostname)) ? '192.168.1.105' : location.hostname;
const API_PROTO = location.protocol === 'file:' ? 'http:' : location.protocol;
const API = `${API_PROTO}//${API_HOST}:8001`;
const statusEl=document.getElementById('status');

const emailEl=document.getElementById('email');
const passEl=document.getElementById('pass');
const params = new URLSearchParams(location.search);
emailEl.value = params.get('email') || '';

function syncPayLink(){
  const email = encodeURIComponent(emailEl.value.trim().toLowerCase());
  document.getElementById('payBtn').href = `commercial-premium-payment.html?email=${email}`;
}
emailEl.addEventListener('input', syncPayLink);
syncPayLink();

async function api(path, method='GET', body){
  try {
    const r = await fetch(API+path, {
      method,
      headers: {'Content-Type':'application/json'},
      credentials: 'include',
      body: body ? JSON.stringify(body) : undefined,
    });
    let j={}; try{ j=await r.json(); }catch{}
    if(!r.ok || j.ok===false) throw new Error(j.error || `http_${r.status}`);
    return j;
  } catch (e) {
    const users = JSON.parse(localStorage.getItem('bitdash_users')||'{}');
    if (path==='/auth/login' && method==='POST') {
      const u = users[body.email];
      if (!u) throw new Error('invalid_credentials');
      if (!u.verified) throw new Error('email_not_verified');
      if (u.password !== body.password) throw new Error('invalid_credentials');
      localStorage.setItem('bitdash_local_user', body.email);
      return { ok:true };
    }
    throw e;
  }
}

document.getElementById('login').onclick = async ()=>{
  const email=emailEl.value.trim().toLowerCase();
  const password=passEl.value;
  if(!email || !password){ statusEl.textContent='Preencha e-mail e senha.'; return; }
  try{
    await api('/auth/login','POST',{email,password});
    statusEl.textContent = 'Login OK. Redirecionando...';
    setTimeout(()=>location.href='commercial-dashboard.html',600);
  }catch(e){
    if (String(e.message).includes('invalid_credentials')) {
      statusEl.textContent = 'Usuário não cadastrado premium. Redirecionando para pagamento...';
      setTimeout(()=>location.href=`commercial-premium-payment.html?email=${encodeURIComponent(email)}`,700);
      return;
    }
    if (String(e.message).includes('email_not_verified')) {
      statusEl.textContent = 'E-mail ainda não validado. Abra a tela de confirmação.';
      setTimeout(()=>location.href=`commercial-verify.html?email=${encodeURIComponent(email)}`,700);
      return;
    }
    statusEl.textContent = `Erro no login: ${e.message}`;
  }
};
</script>
</body></html>
